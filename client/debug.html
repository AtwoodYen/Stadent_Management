<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²è¡¨èª¿è©¦é é¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        .result { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <h1>èª²è¡¨ç³»çµ±èª¿è©¦é é¢</h1>
    
    <div class="section">
        <h2>API æ¸¬è©¦</h2>
        <button class="button" onclick="testStudentsAPI()">æ¸¬è©¦å­¸ç”Ÿ API</button>
        <button class="button" onclick="testSchedulesAPI()">æ¸¬è©¦èª²è¡¨ API</button>
        <div id="api-results"></div>
    </div>
    
    <div class="section">
        <h2>è³‡æ–™è½‰æ›æ¸¬è©¦</h2>
        <button class="button" onclick="testDataTransformation()">æ¸¬è©¦è³‡æ–™è½‰æ›é‚è¼¯</button>
        <div id="transform-results"></div>
    </div>
    
    <div class="section">
        <h2>é€±è¦–åœ–æ¸¬è©¦</h2>
        <button class="button" onclick="testWeekView()">æ¸¬è©¦é€±è¦–åœ–é‚è¼¯</button>
        <div id="week-results"></div>
    </div>

    <script>
        async function testStudentsAPI() {
            const resultsDiv = document.getElementById('api-results');
            try {
                console.log('ğŸ”„ æ¸¬è©¦å­¸ç”Ÿ API...');
                const response = await fetch('/api/students');
                const data = await response.json();
                
                resultsDiv.innerHTML += `
                    <div class="result">
                        <strong>å­¸ç”Ÿ API çµæœ:</strong><br>
                        ç‹€æ…‹: ${response.status}<br>
                        è³‡æ–™ç­†æ•¸: ${data.length}<br>
                        <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>
                    </div>
                `;
                console.log('âœ… å­¸ç”Ÿ API æ¸¬è©¦å®Œæˆ:', data);
            } catch (error) {
                resultsDiv.innerHTML += `<div class="result error">å­¸ç”Ÿ API éŒ¯èª¤: ${error.message}</div>`;
                console.error('âŒ å­¸ç”Ÿ API éŒ¯èª¤:', error);
            }
        }
        
        async function testSchedulesAPI() {
            const resultsDiv = document.getElementById('api-results');
            try {
                console.log('ğŸ”„ æ¸¬è©¦èª²è¡¨ API...');
                const response = await fetch('/api/schedules');
                const data = await response.json();
                
                resultsDiv.innerHTML += `
                    <div class="result">
                        <strong>èª²è¡¨ API çµæœ:</strong><br>
                        ç‹€æ…‹: ${response.status}<br>
                        è³‡æ–™ç­†æ•¸: ${data.length}<br>
                        <pre>${JSON.stringify(data.slice(0, 2), null, 2)}</pre>
                    </div>
                `;
                console.log('âœ… èª²è¡¨ API æ¸¬è©¦å®Œæˆ:', data);
            } catch (error) {
                resultsDiv.innerHTML += `<div class="result error">èª²è¡¨ API éŒ¯èª¤: ${error.message}</div>`;
                console.error('âŒ èª²è¡¨ API éŒ¯èª¤:', error);
            }
        }
        
        async function testDataTransformation() {
            const resultsDiv = document.getElementById('transform-results');
            try {
                console.log('ğŸ”„ æ¸¬è©¦è³‡æ–™è½‰æ›...');
                
                // è¼‰å…¥è³‡æ–™
                const [studentsRes, schedulesRes] = await Promise.all([
                    fetch('/api/students'),
                    fetch('/api/schedules')
                ]);
                
                const studentsData = await studentsRes.json();
                const schedulesData = await schedulesRes.json();
                
                // æ¨¡æ“¬è½‰æ›é‚è¼¯
                const formattedStudents = studentsData.map(student => ({
                    id: student.id || student.student_id,
                    name: student.chinese_name || student.name || student.student_name || 'æœªçŸ¥å­¸ç”Ÿ',
                    level: student.level_type || student.level || student.grade || 'æœªçŸ¥å¹´ç´š'
                }));
                
                // ç°¡åŒ–çš„èª²ç¨‹è½‰æ›
                const today = new Date();
                const currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - today.getDay() + 1); // é€±ä¸€
                
                const formattedLessons = [];
                const dayMap = {
                    'æ˜ŸæœŸä¸€': 1, 'æ˜ŸæœŸäºŒ': 2, 'æ˜ŸæœŸä¸‰': 3, 'æ˜ŸæœŸå››': 4,
                    'æ˜ŸæœŸäº”': 5, 'æ˜ŸæœŸå…­': 6, 'æ˜ŸæœŸæ—¥': 0
                };
                
                schedulesData.forEach(schedule => {
                    const dayOfWeek = dayMap[schedule.day_of_week];
                    if (dayOfWeek !== undefined) {
                        const lessonDate = new Date(currentWeekStart);
                        if (dayOfWeek === 0) {
                            lessonDate.setDate(currentWeekStart.getDate() + 6);
                        } else {
                            lessonDate.setDate(currentWeekStart.getDate() + dayOfWeek - 1);
                        }
                        
                        const startTime = schedule.start_time.split('T')[1].slice(0, 5);
                        
                        formattedLessons.push({
                            id: schedule.id,
                            studentId: schedule.student_id,
                            date: lessonDate,
                            startTime: startTime,
                            endTime: schedule.end_time.split('T')[1].slice(0, 5),
                            topic: schedule.subject,
                            status: 'scheduled'
                        });
                    }
                });
                
                resultsDiv.innerHTML += `
                    <div class="result">
                        <strong>è³‡æ–™è½‰æ›çµæœ:</strong><br>
                        å­¸ç”Ÿæ•¸: ${formattedStudents.length}<br>
                        èª²ç¨‹æ•¸: ${formattedLessons.length}<br>
                        æœ¬é€±èª²ç¨‹: ${formattedLessons.filter(l => {
                            const weekStart = new Date(currentWeekStart);
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekStart.getDate() + 6);
                            return l.date >= weekStart && l.date <= weekEnd;
                        }).length}<br>
                        <pre>èª²ç¨‹ç¯„ä¾‹: ${JSON.stringify(formattedLessons.slice(0, 2), null, 2)}</pre>
                    </div>
                `;
                
                console.log('âœ… è³‡æ–™è½‰æ›æ¸¬è©¦å®Œæˆ');
                console.log('å­¸ç”Ÿ:', formattedStudents);
                console.log('èª²ç¨‹:', formattedLessons);
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="result error">è³‡æ–™è½‰æ›éŒ¯èª¤: ${error.message}</div>`;
                console.error('âŒ è³‡æ–™è½‰æ›éŒ¯èª¤:', error);
            }
        }
        
        async function testWeekView() {
            const resultsDiv = document.getElementById('week-results');
            try {
                console.log('ğŸ”„ æ¸¬è©¦é€±è¦–åœ–é‚è¼¯...');
                
                // é€™è£¡æœƒæ¸¬è©¦é€±è¦–åœ–çš„åŸºæœ¬é‚è¼¯
                const today = new Date();
                const currentWeekStart = new Date(today);
                currentWeekStart.setDate(today.getDate() - today.getDay() + 1);
                
                const weekDays = [];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(currentWeekStart);
                    day.setDate(currentWeekStart.getDate() + i);
                    weekDays.push({
                        date: day.toISOString().split('T')[0],
                        dayName: ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][day.getDay()],
                        isToday: day.toDateString() === today.toDateString()
                    });
                }
                
                resultsDiv.innerHTML += `
                    <div class="result">
                        <strong>é€±è¦–åœ–é‚è¼¯æ¸¬è©¦:</strong><br>
                        ä»Šå¤©: ${today.toISOString().split('T')[0]}<br>
                        æœ¬é€±é–‹å§‹: ${currentWeekStart.toISOString().split('T')[0]}<br>
                        é€±å¤©æ•¸: ${weekDays.length}<br>
                        <pre>${JSON.stringify(weekDays, null, 2)}</pre>
                    </div>
                `;
                
                console.log('âœ… é€±è¦–åœ–é‚è¼¯æ¸¬è©¦å®Œæˆ:', weekDays);
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="result error">é€±è¦–åœ–æ¸¬è©¦éŒ¯èª¤: ${error.message}</div>`;
                console.error('âŒ é€±è¦–åœ–æ¸¬è©¦éŒ¯èª¤:', error);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡ŒåŸºæœ¬æ¸¬è©¦
        window.onload = function() {
            console.log('ğŸ”„ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹è‡ªå‹•æ¸¬è©¦...');
            testStudentsAPI();
            setTimeout(() => testSchedulesAPI(), 1000);
            setTimeout(() => testDataTransformation(), 2000);
        };
    </script>
</body>
</html> 